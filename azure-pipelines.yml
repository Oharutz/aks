# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

variables:
  commitMessage: $(Build.SourceVersionMessage)
  TF_VAR_location: 'West US'
  TF_VAR_resource_group_name: 'basicAksRg'
  TF_VAR_aks_cluster_name: 'basicAksCluster'

trigger:
- main


pool:
  name: 'azUbuntuAgentPool'

jobs:
  - job: ConditionalTrigger
    condition: ne(variables['commitMessage'], '[Skip]')
    steps:
    # Step 1: Initialize Terraform
    - task: TerraformTaskV4@4
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'Azure ARM'
        backendAzureRmResourceGroupName: 'basicAksRg'
        backendAzureRmStorageAccountName: 'tfstateaccount1296'
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'tf/terraform.tfstate'

    # Step 2: Validate Terraform
    - script: terraform validate
      displayName: 'Terraform Validate'

    # Step 3: Plan Terraform
    - script: terraform plan -out=tfplan
      displayName: 'Terraform Plan'

    # Step 4: Apply Terraform
    - script: terraform apply -auto-approve tfplan
      displayName: 'Terraform Apply'

    # Step 5: Output kubeconfig (optional)
    - script: |
        echo "Kubeconfig:"
        terraform output kube_config
      displayName: 'Output Kubeconfig'